#!/bin/bash

# Pre-commit hook
# Replaces the current pre-push hook functionality
# Handles testing, build verification, and comprehensive validation

set -e

echo "ðŸš€ Running pre-commit hook (testing & comprehensive validation)..."

# Determine project type
if [ -f "pyproject.toml" ] || [ -f "requirements.txt" ] || [ -f "setup.py" ]; then
    PROJECT_TYPE="python"
elif [ -f "CMakeLists.txt" ] || [ -f "meson.build" ]; then
    PROJECT_TYPE="cpp"
else
    echo "âš ï¸  Unknown project type, running minimal checks"
    PROJECT_TYPE="unknown"
fi

echo "ðŸ“¦ Detected project type: $PROJECT_TYPE"

# Function to run Python tests and validation
run_python_validation() {
    echo "ðŸ§ª Running Python testing and validation..."

    # Check if we're in a virtual environment
    if [ -d "venv" ]; then
        source venv/bin/activate
        echo "ðŸ”§ Activated virtual environment"
    elif [ -n "$VIRTUAL_ENV" ]; then
        echo "ðŸ”§ Virtual environment already active: $VIRTUAL_ENV"
    else
        echo "âš ï¸  No virtual environment detected, some checks may fail"
    fi

    # Install dependencies if requirements.txt exists
    if [ -f "requirements.txt" ] && command -v pip >/dev/null 2>&1; then
        echo "ðŸ“¦ Installing/updating dependencies..."
        pip install -q -r requirements.txt || echo "âš ï¸  Some dependencies may not be installed"
    fi

    # Install dev dependencies if pyproject.toml has dev dependencies
    if [ -f "pyproject.toml" ] && command -v pip >/dev/null 2>&1; then
        echo "ðŸ“¦ Installing development dependencies..."
        pip install -q pytest pytest-cov ruff mypy || echo "âš ï¸  Some dev dependencies may not be installed"
    fi

    # Run pytest if available
    if command -v pytest >/dev/null 2>&1; then
        echo "ðŸ§ª Running pytest..."
        if [ -d "tests" ] || [ -d "test" ]; then
            pytest --tb=short -v || echo "âš ï¸  Some tests may have failed, but continuing..."
        else
            echo "â„¹ï¸  No tests directory found, skipping pytest"
        fi
    else
        echo "âš ï¸  pytest not found, skipping tests"
    fi

    # Run coverage if available
    if command -v pytest >/dev/null 2>&1 && pip show pytest-cov >/dev/null 2>&1; then
        echo "ðŸ“Š Running coverage report..."
        pytest --cov=src --cov-report=term-missing --tb=short || echo "âš ï¸  Coverage run completed with warnings"
    fi

    # Check package build if it's a package project
    if [ -f "pyproject.toml" ] && command -v build >/dev/null 2>&1; then
        echo "ðŸ—ï¸  Testing package build..."
        python -m build --wheel --outdir /tmp/ || echo "âš ï¸  Package build may have issues"
    fi
}

# Function to run C++ tests and validation
run_cpp_validation() {
    echo "ðŸ”§ Running C++ testing and validation..."

    # Check build directory
    BUILD_DIR="build"
    if [ ! -d "$BUILD_DIR" ]; then
        echo "ðŸ“ Creating build directory..."
        mkdir -p "$BUILD_DIR"
    fi

    # Configure with CMake
    if [ -f "CMakeLists.txt" ] && command -v cmake >/dev/null 2>&1; then
        echo "âš™ï¸  Configuring with CMake..."
        cd "$BUILD_DIR"
        cmake .. -DCMAKE_BUILD_TYPE=Debug || echo "âš ï¸  CMake configuration may have issues"

        # Build
        echo "ðŸ—ï¸  Building project..."
        cmake --build . --config Debug || echo "âš ï¸  Build may have completed with warnings"

        # Run tests if they exist
        if command -v ctest >/dev/null 2>&1; then
            echo "ðŸ§ª Running CTest..."
            ctest --output-on-failure --verbose || echo "âš ï¸  Some tests may have failed"
        fi

        cd ..
    elif [ -f "meson.build" ] && command -v meson >/dev/null 2>&1; then
        echo "âš™ï¸  Configuring with Meson..."
        if [ ! -d "$BUILD_DIR" ]; then
            meson setup "$BUILD_DIR" || echo "âš ï¸  Meson setup may have issues"
        fi

        echo "ðŸ—ï¸  Building project..."
        meson compile -C "$BUILD_DIR" || echo "âš ï¸  Build may have completed with warnings"

        echo "ðŸ§ª Running tests..."
        meson test -C "$BUILD_DIR" || echo "âš ï¸  Some tests may have failed"
    else
        echo "âš ï¸  No supported build system found, skipping build tests"
    fi

    # Run additional C++ checks
    if command -v cppcheck >/dev/null 2>&1; then
        echo "ðŸ” Running cppcheck..."
        cppcheck --enable=all --suppress=missingIncludeSystem --inline-suppr --error-exitcode=0 src/ || echo "âš ï¸  cppcheck completed with warnings"
    fi
}

# Function to run security checks
run_security_checks() {
    echo "ðŸ”’ Running security checks..."

    # Check for sensitive files
    echo "ðŸ” Checking for sensitive files..."
    SENSITIVE_PATTERNS=(
        "*.pem"
        "*.key"
        "*.p12"
        "*.pfx"
        "id_rsa"
        "id_dsa"
        "*.pem"
        ".env"
        "password"
        "secret"
        "token"
    )

    for pattern in "${SENSITIVE_PATTERNS[@]}"; do
        if find . -name "$pattern" -not -path "./.git/*" -not -path "./venv/*" -not -path "./build/*" | head -1 | grep -q .; then
            echo "âš ï¸  Potentially sensitive files found matching pattern: $pattern"
        fi
    done

    # Check for hardcoded secrets in code
    echo "ðŸ” Checking for hardcoded secrets..."
    if command -v grep >/dev/null 2>&1; then
        SECRET_PATTERNS=(
            "password\s*=\s*['\"][^'\"]+['\"]"
            "api_key\s*=\s*['\"][^'\"]+['\"]"
            "secret\s*=\s*['\"][^'\"]+['\"]"
            "token\s*=\s*['\"][^'\"]+['\"]"
        )

        for pattern in "${SECRET_PATTERNS[@]}"; do
            if grep -r "$pattern" --include="*.py" --include="*.cpp" --include="*.hpp" --include="*.js" --include="*.ts" . 2>/dev/null | head -3 | grep -q .; then
                echo "âš ï¸  Potential hardcoded secrets found"
            fi
        done
    fi
}

# Function to run dependency checks
run_dependency_checks() {
    echo "ðŸ“¦ Running dependency checks..."

    # Python dependency checks
    if [ "$PROJECT_TYPE" = "python" ]; then
        # Check for known vulnerabilities if safety is available
        if command -v safety >/dev/null 2>&1; then
            echo "ðŸ”’ Checking for known vulnerabilities..."
            safety check --json || echo "âš ï¸  Safety check completed with warnings"
        fi

        # Check for outdated packages if pip-tools is available
        if command -v pip-review >/dev/null 2>&1; then
            echo "ðŸ“Š Checking for outdated packages..."
            pip-review --local || echo "âš ï¸  Some packages may be outdated"
        fi
    fi
}

# Function to run performance checks
run_performance_checks() {
    echo "âš¡ Running performance checks..."

    # Python performance checks
    if [ "$PROJECT_TYPE" = "python" ] && command -v python >/dev/null 2>&1; then
        echo "ðŸ“Š Checking Python code complexity..."
        # Basic complexity check
        find . -name "*.py" -not -path "./venv/*" -not -path "./build/*" | while read file; do
            lines=$(wc -l < "$file")
            if [ "$lines" -gt 500 ]; then
                echo "âš ï¸  Large file detected: $file ($lines lines)"
            fi
        done
    fi
}

# Main execution
echo "ðŸŽ¯ Starting comprehensive validation..."

case $PROJECT_TYPE in
    "python")
        run_python_validation
        ;;
    "cpp")
        run_cpp_validation
        ;;
    "unknown")
        echo "â„¹ï¸  Running minimal checks for unknown project type"
        ;;
esac

run_security_checks
run_dependency_checks
run_performance_checks

echo ""
echo "âœ… All pre-commit validation completed!"
echo ""
echo "ðŸ“‹ Validation Summary:"
echo "   - Tests executed"
echo "   - Build verified (if applicable)"
echo "   - Security scans performed"
echo "   - Dependencies checked"
echo "   - Performance analysis completed"
echo ""
echo "ðŸŽ‰ Your code is ready to be committed!"